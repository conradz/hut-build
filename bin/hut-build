#!/usr/bin/env node
/*jshint node: true */

var opts = require('nomnom'),
    build = require('../');

opts.command('lint')
    .callback(lint)
    .help('Run JSHint');

opts.command('serve')
    .callback(serve)
    .options({
        debug: { abbr: 'd', flag: true, help: 'Enable source maps' },
        port: { abbr: 'p', help: 'Port for the HTTP server' }
    })
    .help('Serve files');

opts.command('build')
    .callback(runBuild)
    .help('Build files');

opts.command('test')
    .callback(test)
    .help('Lint and run tests in Sauce Labs');

opts.parse();

function handle(err) {
    if (err) {
        console.error(err);
        process.exit(1);
    }
}

function lint() {
    build.lint(process.cwd(), handle);
}

function serve(options) {
    build.serve(process.cwd(), options, serving);

    function serving(err, server) {
        if (err) {
            return handle(err);
        }

        var addr = server.address();
        console.log('Server listening on', addr.address + ':' + addr.port);
    }
}

function runBuild() {
    build.build(process.cwd(), handle);
}

function test() {
    build.lint(process.cwd(), linted);

    function linted(err) {
        if (err) {
            return handle(err);
        }

        build.test(process.cwd(), handle);
    }
}